# Конфигурация Xray Telegram Manager

Данный документ описывает все параметры конфигурации для Xray Telegram Manager.

## Структура конфигурации

Конфигурация хранится в файле `/opt/etc/xray-manager/config.json` в формате JSON.

## Основные параметры

### admin_id (обязательно)
- **Тип**: число
- **Описание**: Telegram ID администратора, который может управлять ботом
- **Пример**: `123456789`
- **Как получить**: Напишите @userinfobot в Telegram

### bot_token (обязательно)
- **Тип**: строка
- **Описание**: Токен Telegram бота
- **Пример**: `"1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"`
- **Как получить**: Создайте бота через @BotFather

### subscription_url (обязательно)
- **Тип**: строка
- **Описание**: URL подписки с серверами в формате base64
- **Пример**: `"https://example.com/subscription.txt"`

### config_path
- **Тип**: строка
- **По умолчанию**: `"/opt/etc/xray/configs/04_outbounds.json"`
- **Описание**: Путь к конфигурационному файлу Xray

### log_level
- **Тип**: строка
- **По умолчанию**: `"info"`
- **Возможные значения**: `"debug"`, `"info"`, `"warn"`, `"error"`
- **Описание**: Уровень детализации логирования

### xray_restart_command
- **Тип**: строка
- **По умолчанию**: `"/opt/etc/init.d/S24xray restart"`
- **Описание**: Команда для перезапуска сервиса Xray

### cache_duration
- **Тип**: число
- **По умолчанию**: `3600`
- **Описание**: Время кэширования подписки в секундах

### health_check_interval
- **Тип**: число
- **По умолчанию**: `300`
- **Описание**: Интервал проверки здоровья сервиса в секундах

### ping_timeout
- **Тип**: число
- **По умолчанию**: `5`
- **Описание**: Таймаут для тестирования пинга в секундах

## Настройки интерфейса (ui)

### max_button_text_length
- **Тип**: число
- **По умолчанию**: `50`
- **Описание**: Максимальная длина текста кнопки в символах
- **Примечание**: Учитывает длину эмодзи при расчете

### servers_per_page
- **Тип**: число
- **По умолчанию**: `32`
- **Описание**: Количество серверов, отображаемых на одной странице
- **Рекомендация**: Не более 40 для удобства использования

### max_quick_select_servers
- **Тип**: число
- **По умолчанию**: `10`
- **Описание**: Максимальное количество серверов в быстром выборе после пинг-теста

### message_timeout_minutes
- **Тип**: число
- **По умолчанию**: `60`
- **Описание**: Время жизни активных сообщений в минутах
- **Примечание**: После истечения времени сообщения будут удалены из памяти

### enable_name_optimization
- **Тип**: булево значение
- **По умолчанию**: `true`
- **Описание**: Включить автоматическую оптимизацию имен серверов
- **Функция**: Удаляет общие суффиксы из имен серверов для лучшей читаемости

### name_optimization_threshold
- **Тип**: число (0.0 - 1.0)
- **По умолчанию**: `0.7`
- **Описание**: Порог для применения оптимизации имен
- **Пример**: `0.7` означает, что суффикс будет удален, если он встречается у 70% или более серверов

## Настройки обновления (update)

### script_url
- **Тип**: строка
- **По умолчанию**: `"https://raw.githubusercontent.com/ad/xray-subscription-telegram-manager-for-keenetic/main/scripts/quick-install.sh"`
- **Описание**: URL скрипта для автоматического обновления
- **Безопасность**: Используйте только проверенные источники

### timeout_minutes
- **Тип**: число
- **По умолчанию**: `10`
- **Описание**: Максимальное время выполнения обновления в минутах

### backup_config
- **Тип**: булево значение
- **По умолчанию**: `true`
- **Описание**: Создавать резервную копию конфигурации перед обновлением
- **Рекомендация**: Всегда оставляйте `true` для безопасности

## Пример полной конфигурации

```json
{
    "admin_id": 123456789,
    "bot_token": "1234567890:ABCdefGHIjklMNOpqrsTUVwxyz",
    "config_path": "/opt/etc/xray/configs/04_outbounds.json",
    "subscription_url": "https://example.com/subscription.txt",
    "log_level": "info",
    "xray_restart_command": "/opt/etc/init.d/S24xray restart",
    "cache_duration": 3600,
    "health_check_interval": 300,
    "ping_timeout": 5,
    "ui": {
        "max_button_text_length": 50,
        "servers_per_page": 32,
        "max_quick_select_servers": 10,
        "message_timeout_minutes": 60,
        "enable_name_optimization": true,
        "name_optimization_threshold": 0.7
    },
    "update": {
        "script_url": "https://raw.githubusercontent.com/ad/xray-subscription-telegram-manager-for-keenetic/main/scripts/quick-install.sh",
        "timeout_minutes": 10,
        "backup_config": true
    }
}
```

## Валидация конфигурации

При запуске приложение проверяет:

1. **Обязательные параметры**: `admin_id`, `bot_token`, `subscription_url`
2. **Корректность значений**: числовые параметры должны быть положительными
3. **Доступность файлов**: проверяется существование `config_path`
4. **Формат URL**: проверяется корректность `subscription_url` и `script_url`

## Рекомендации по настройке

### Для небольшого количества серверов (< 20)
```json
{
    "ui": {
        "servers_per_page": 20,
        "max_quick_select_servers": 5,
        "enable_name_optimization": false
    }
}
```

### Для большого количества серверов (> 100)
```json
{
    "ui": {
        "servers_per_page": 40,
        "max_quick_select_servers": 15,
        "enable_name_optimization": true,
        "name_optimization_threshold": 0.6
    }
}
```

### Для медленных соединений
```json
{
    "ping_timeout": 10,
    "cache_duration": 7200,
    "update": {
        "timeout_minutes": 15
    }
}
```

## Безопасность

1. **Защита admin_id**: Никогда не делитесь своим Telegram ID
2. **Защита bot_token**: Храните токен в секрете, не публикуйте в открытых репозиториях
3. **Проверка script_url**: Используйте только доверенные источники для обновлений
4. **Резервные копии**: Всегда включайте `backup_config: true`

## Миграция конфигурации

При обновлении с предыдущих версий:

1. Новые параметры будут использовать значения по умолчанию
2. Старые параметры остаются совместимыми
3. Рекомендуется добавить новые секции `ui` и `update` для полной функциональности

## Устранение проблем

### Ошибки валидации
- Проверьте синтаксис JSON с помощью онлайн-валидаторов
- Убедитесь, что все строки заключены в кавычки
- Проверьте наличие запятых между параметрами

### Проблемы с производительностью
- Уменьшите `servers_per_page` если интерфейс медленно загружается
- Увеличьте `cache_duration` для уменьшения нагрузки на сеть
- Отключите `enable_name_optimization` если обработка серверов занимает много времени